@using Microsoft.ML
@using Microsoft.ML.Data

<h3>AI Chatbot</h3>
<div class="row">
    <div class="column">
        <button class="btn btn-primary" @onclick="TrainAI">Train AI</button>
    </div>
</div>

<div class="row">
    <div class="chat-container">
        @foreach (var message in messages)
        {
            <div class="message @(message.IsBotMessage ? "bot-message" : "user-message")">
                @message.Text
            </div>
        }
    </div>
</div>
<div class="input-container">
    <textarea @bind="userInput" rows="4" cols="50"></textarea>
    <button @onclick="SendMessage">Send</button>
</div>

@code {
    [Parameter] public string ConnectionString { get; set; }

    private string userInput;
    private List<Message> messages = new List<Message>();
    private PredictionEngine<SentimentData, SentimentPrediction> predictionEngine;
    private AIDataAccess _da;

    protected override async Task OnInitializedAsync()
    {
        // Initialize ML.NET model
        var mlContext = new MLContext();
        _da = new AIDataAccess(ConnectionString);

        // Retrieve model file from database
        var modelData = await _da.GetModelFileAsync("SentimentAnalysisModel.zip");
        if (modelData != null)
        {
            using var modelStream = new MemoryStream(modelData);
            var model = mlContext.Model.Load(modelStream, out _);
            predictionEngine = mlContext.Model.CreatePredictionEngine<SentimentData, SentimentPrediction>(model);
        }
        else
        {
            Console.WriteLine("Model file not found in database.");
        }

        await base.OnInitializedAsync();
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(userInput))
        {
            messages.Add(new Message { Text = userInput, IsBotMessage = false });
            StateHasChanged();

            await HandleUserMessage(userInput);

            userInput = string.Empty;
        }
    }

    private async Task HandleUserMessage(string userMessage)
    {
        if (userMessage.ToLower().StartsWith("add info about"))
        {
            var parts = userMessage.Split(new[] { "add info about", ":" }, StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length == 2)
            {
                var topic = parts[0].Trim();
                var information = parts[1].Trim();
                await AddGeneralInformation(topic, information);
            }
        }
        else if (userMessage.ToLower().StartsWith("what is"))
        {
            // Remove punctuation marks
            userMessage = RemovePunctuation(userMessage);
            var topic = userMessage.Substring("what is".Length).Trim();
            var information = await _da.GetGeneralInformationAsync(topic);
            if (information != null)
            {
                messages.Add(new Message { Text = information, IsBotMessage = true });
            }
            else
            {
                messages.Add(new Message { Text = "I don't have information about that topic.", IsBotMessage = true });
            }
            StateHasChanged();
        }
        else
        {
            // Use ML.NET model to predict sentiment
            var prediction = predictionEngine.Predict(new SentimentData { SentimentText = userMessage });

            var response = prediction.Prediction ? "Positive sentiment" : "Negative sentiment";
            messages.Add(new Message { Text = response, IsBotMessage = true });
            StateHasChanged();

            // Store user input in database for future training
            var trainingData = new TrainingData { SentimentText = userMessage, Sentiment = prediction.Prediction };
            await _da.InsertTrainingDataAsync(trainingData);
        }
    }

    private string RemovePunctuation(string text)
    {
        // Define punctuation marks to remove
        var punctuation = new char[] { '.', ',', '!', '?', ';' };

        // Remove punctuation from the end of the text
        while (text.Length > 0 && punctuation.Contains(text[^1]))
        {
            text = text.Remove(text.Length - 1);
        }

        return text.Trim();
    }

    private async Task TrainAI()
    {
        try
        {
            // Training logic
            var mlContext = new MLContext();
            var dataPath = "Data/sentiment-data.csv";

            // Load data
            var data = mlContext.Data.LoadFromTextFile<SentimentData>(dataPath, separatorChar: ',', hasHeader: true);

            // Data processing pipeline
            var dataProcessPipeline = mlContext.Transforms.Text.FeaturizeText("Features", nameof(SentimentData.SentimentText))
                                        .Append(mlContext.Transforms.CopyColumns("Label", nameof(SentimentData.Sentiment)));

            // Choose a learning algorithm
            var trainer = mlContext.BinaryClassification.Trainers.SdcaLogisticRegression(labelColumnName: "Label", featureColumnName: "Features");

            var trainingPipeline = dataProcessPipeline.Append(trainer);

            // Train the model
            var trainedModel = trainingPipeline.Fit(data);

            // Save the model to a memory stream
            using var memoryStream = new MemoryStream();
            mlContext.Model.Save(trainedModel, data.Schema, memoryStream);

            // Store the model in the database
            var fileName = "SentimentAnalysisModel.zip"; // Adjust filename as needed
            await _da.InsertModelFileAsync(fileName, memoryStream.ToArray());

            // Provide feedback or update UI after training
            messages.Add(new Message { Text = "Model trained successfully!", IsBotMessage = true });
            StateHasChanged();

            // Optionally, wait for a short delay before clearing the message
            await Task.Delay(3000); // Adjust delay time as needed

            // Clear the training message
            messages.RemoveAll(msg => msg.Text == "Model trained successfully!");
            StateHasChanged();

        }
        catch (Exception ex)
        {
            Console.WriteLine("Error: {0}", ex.Message);
        }
    }

    private async Task AddGeneralInformation(string topic, string information)
    {
        try
        {
            await _da.InsertGeneralInformationAsync(topic, information);
            messages.Add(new Message { Text = $"Information about {topic} added successfully!", IsBotMessage = true });
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error: {0}", ex.Message);
        }
    }
}
