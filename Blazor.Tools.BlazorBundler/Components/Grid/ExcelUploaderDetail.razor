@*====================================================================================================
    Component Name: ExcelUploaderDetail.razor
    Created By    : Solomio S. Sisante
    Created On    : June 3, 2024
    Purpose       : To provide the ExcelUploader component a Detail component.
  ====================================================================================================*@
@using Blazor.Tools.BlazorBundler.Components.Grid
@using Blazor.Tools.BlazorBundler.Entities
@using Blazor.Tools.BlazorBundler.Extensions
@using Blazor.Tools.BlazorBundler.Interfaces
@using BlazorBootstrap
@using System.Data
@using System.Reflection

@if (ExcelDataSet != null && ExcelDataSet.Tables.Count > 0)
{
    <div>
        <ul class="nav nav-tabs">
            @foreach (var table in ExcelDataSet.Tables.Cast<DataTable>())
            {
                <li class="nav-item">
                    <a class="cursor-pointer nav-link @(table == _selectedTable ? "active" : "")" @onclick="() => SelectTableAsync(table)">@table.TableName</a>
                </li>
            }
        </ul>

        <div class="tab-content">
            @if (_selectedTable != null)
            {
                <div class="tab-pane fade show active">
                    <h4>@_selectedTable.TableName</h4>
                    <DataTableGrid SelectedTable="@_selectedTable"
                                   AllowCellSelection="true"
                                   TableList="@_tableList" />
                </div>
            }
            else
            {
                <p>Select a table to view its data.</p>
            }
        </div>
        <div class="mt-3">
            <Icon Name="IconName.Upload" Class="cursor-pointer" @onclick="UploadData" title="Upload to new tables" />
        </div>
    </div>
}
else
{
    <p>No data available.</p>
}

@code {
    [Parameter] public DataSet? ExcelDataSet { get; set; } = default!;
    [Parameter] public ExcelProcessor ExcelProcessor { get; set; } = default!;
    [Parameter] public string ModelsAssemblyName { get; set; } = default!; //"AccSol.EF.Interfaces"
    [Parameter] public string ModelsAssemblyPath { get; set; } = default!; // @"C:\repo\AccSol\AccSol.Interfaces\bin\Debug\net8.0\AccSol.Interfaces.dll"
    [Parameter] public string ServicesAssemblyName { get; set; } = default!; //"AccSol.Services"
    [Parameter] public string ServicesAssemblyPath { get; set; } = default!; // @"C:\repo\AccSol\AccSol.Services\bin\Debug\net8.0\AccSol.Services.dll"
    [Parameter] public bool LoadAssemblyFromDLLFile { get; set; } = false;
    [Parameter] public bool IsInterface { get; set; } = false;

    // [Inject] public ICommonService<SessionTable, ISessionTable, IReportItem> _sessionTableService { get; set; } = default!;
    // [Inject] public SessionTable _sessionTable { get; set; } = default!;

    private DataTable? _selectedTable;
    private string? _selectedTableName;
    private bool _isReceived = false;
    private List<AssemblyTable>? _tableList = null;
    protected override async Task OnParametersSetAsync()
    {
        Assembly? assembly = null;
        if (LoadAssemblyFromDLLFile)
        {
            if (ModelsAssemblyPath == null)
            {
                throw new ArgumentException("ModelsAssemblyPath is required.");
            }
            else
            {
                assembly = ReflectionExtensions.LoadAssemblyFromDLLFile(ModelsAssemblyPath);
            }

        }

        if (!LoadAssemblyFromDLLFile)
        {
            if (ModelsAssemblyName == null)
            {
                throw new ArgumentException("ModelsAssemblyName is required.");
            }
            else
            {
                assembly = ReflectionExtensions.LoadAssemblyFromName(ModelsAssemblyName);
            }
        }

        var interfaceNames = assembly?.GetAssemblyInterfaceNames();

        if (interfaceNames != null)
        {
            foreach (var iFace in interfaceNames)
            {
                var assemblyTable = new AssemblyTable()
                    {
                        ID = i,
                        AssemblyName = ModelsAssemblyName,
                        AssemblyPath = ModelsAssemblyPath,
                        IsInterface = IsInterface,
                        TableName = iFace.Item2.SubString(1, iFace.Item2.Length - 1),
                        TypeName = iFace.Item2
                    };

                _tableList.Add(assemblyTable);
            }
        }

        if (_tableList == null)
        {
            _tableList = new List<AssemblyTable>();
        }

        if (ExcelDataSet != null)
        {

            var tables = ExcelDataSet?.Tables;
            if (tables != null)
            {
                for (int i = 0; i < tables.Count; i++)
                {
                    DataTable table = tables[i];
                    var assemblyTable = new AssemblyTable()
                        {
                            ID = i,
                            AssemblyName = ModelsAssemblyName,
                            AssemblyPath = ModelsAssemblyPath,
                            IsInterface = true,
                            TableName = table.TableName,
                            TypeName = $"I{table.TableName}"
                        };
                }
            }
        }

        await base.OnParametersSetAsync();

        // if (!_isReceived)
        // {
        //     await RetrieveDataFromSessionTableAsync();
        // }
    }

    private async Task SelectTableAsync(DataTable table)
    {
        _selectedTable = table;
        _selectedTableName = table.TableName;
        //await SaveDataToSessionTableAsync();
        await Task.CompletedTask;
    }

    // private async Task RetrieveDataFromSessionTableAsync()
    // {
    //     try
    //     {
    //         var sessionManager = new SessionManager(_sessionTableService);
    //         _excelDataSet = await sessionManager.RetrieveFromSessionTableAsync<DataSet>("_excelDataSet");
    //         _selectedTable = await sessionManager.RetrieveFromSessionTableAsync<DataTable>("_selectedTable");
    //         _selectedTableName = await sessionManager.RetrieveFromSessionTableAsync<string?>("_selectedTableName");

    //         if (_selectedTable != null)
    //         {
    //             _selectedTable.TableName = _selectedTableName;
    //         }

    //         _isReceived = true;

    //         StateHasChanged();
    //     }
    //     catch (Exception ex)
    //     {
    //         Console.WriteLine("Error: {0}", ex.Message);
    //     }
    // }

    // private async Task SaveDataToSessionTableAsync()
    // {
    //     try
    //     {
    //         var sessionManager = new SessionManager(_sessionTableService);
    //         await sessionManager.SaveToSessionTableAsync("_excelDataSet", _excelDataSet, serialize: true);
    //         await sessionManager.SaveToSessionTableAsync("_selectedTable", _selectedTable, serialize: true);
    //         await sessionManager.SaveToSessionTableAsync("_selectedTableName", _selectedTableName, serialize: false);
    //     }
    //     catch (Exception ex)
    //     {
    //         Console.WriteLine("Error: {0}", ex.Message);
    //     }
    // }

    private async Task UploadData()
    {
        if (ExcelDataSet != null)
        {
            if (ExcelProcessor != null)
            {
                await ExcelProcessor.SaveDataToDatabaseAsync(ExcelDataSet);
            }

            //TODO: sol: Optionally, show a success message or handle post-upload actions
        }
    }
}
